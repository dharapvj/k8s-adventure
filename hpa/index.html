<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" href="/k8s-adventure/css/adventure.ico" type="image/x-icon">
    <link rel="stylesheet" href="/k8s-adventure/css/bootstrap.min.css">
    <link href="/k8s-adventure/css/prism-vsc-dark-plus.css" rel="stylesheet" type="text/css">
    <link href="/k8s-adventure/css/blog.css" rel="stylesheet" type="text/css">
  <title>My Kubernetes Adventures - Horizontal Pod Autoscaler</title>
</head>

<body>
  <header>
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
    <div class="container">
      <a class="navbar-brand" href="/k8s-adventure/">My Kubernetes Adventures</a>
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        Menu
        <i class="fas fa-bars"></i>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="/">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/about/">About</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/contact/">Contact</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  </header>
  <!-- <section class="masthead">
    <div class="container">
      <h1 class="title"> Horizontal Pod Autoscaler </h1>
      <div class="author"> by Vijay Dharap </div>
      <div class="ts"> <span> January 20, 2021 </span> / <span>hpa,autoscaling,metrics</span></div>  
    </div>
  </section> -->
  <section class="main">
    <div class="container">
      <div class="row">
        <div class="col-lg-9 col-md-10 mx-auto">
          <h1>Horizontal Pod Autoscaler</h1>
<p><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/">Horizontal Pod Autoscaler</a> (HPA) is a technology by which kubernetes cluster can scale the number of replicas for a given deployment automatically.</p>
<p>It does this by using metric gathered by metrics server. Some of the managed kubernetes distributions provide specific instructiosn to enable metrics server first. Please use those before enabling and testing HPA</p>
<h2>KOPS Specific instructions</h2>
<p>Make sure you are using right release tag for the instructions. From v1.19 the process to enable metrics server has become a LOT easier.
<a href="https://github.com/kubernetes/kops/tree/release-1.18/addons/metrics-server">Install metrics-server on KOPS v1.18</a></p>
<h2>EKS specific instructions</h2>
<p>Follow instruction <a href="https://docs.aws.amazon.com/eks/latest/userguide/horizontal-pod-autoscaler.html">here</a> to add metrics-server and then add autoscaling test aplication. Most of the instructions below are valid for EKS as well after metrics-server is installed from the link.</p>
<h2>Verify that Metrics server is running.</h2>
<p>First of all - it takes about 5 minutes for metrics server to start reporting metrics after installation.</p>
<pre class="language-shell"><code class="language-shell">kubectl <span class="token function">top</span> node<br>kubectl <span class="token function">top</span> pod</code></pre>
<h2>Enable HPA for the given deployment</h2>
<pre class="language-shell"><code class="language-shell"><span class="token comment"># Let us deploy a sample application with considerable amount of CPU usage.</span><br><span class="token comment"># source code for this app can be seen at https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/</span><br>kubectl apply -f https://k8s.io/examples/application/php-apache.yaml<br><span class="token comment"># Enable Autoscaling with CPU threshold at 50m</span><br>kubectl autoscale deployment php-apache --cpu-percent<span class="token operator">=</span><span class="token number">50</span> --min<span class="token operator">=</span><span class="token number">1</span> --max<span class="token operator">=</span><span class="token number">10</span><br><span class="token comment"># validate HPA is setup properly. If you get "Unknown" in Target column, your metrics server is not working properly.</span><br>kubectl get hpa</code></pre>
<h2>Test HPA</h2>
<p>Run following in separate shell as this command blocks the terminal, until you exit</p>
<pre class="language-shell"><code class="language-shell">kubectl run -i --tty load-generator --rm --image<span class="token operator">=</span>busybox --restart<span class="token operator">=</span>Never -- /bin/sh -c <span class="token string">"while sleep 0.01; do wget -q -O- http://php-apache; done"</span></code></pre>
<p>Now if you again check your HPA, you should see additional replicas getting created in a minute or so.</p>
<p>You can notice the load increase reported in targets column and then subsequent scaling up of replicas. After the load generator was stopped, you can see that load goes down. Replica count also comes down after about 5 minutes of cooling period.</p>
<pre class="language-shell"><code class="language-shell"><span class="token comment"># sample output</span><br>$ kubectl get hpa -w<br>NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE<br>php-apache   Deployment/php-apache   <span class="token number">0</span>%/50%    <span class="token number">1</span>         <span class="token number">10</span>        <span class="token number">1</span>          2m52s<br>php-apache   Deployment/php-apache   <span class="token number">250</span>%/50%   <span class="token number">1</span>         <span class="token number">10</span>        <span class="token number">1</span>          3m48s<br>php-apache   Deployment/php-apache   <span class="token number">250</span>%/50%   <span class="token number">1</span>         <span class="token number">10</span>        <span class="token number">4</span>          4m4s<br>php-apache   Deployment/php-apache   <span class="token number">250</span>%/50%   <span class="token number">1</span>         <span class="token number">10</span>        <span class="token number">5</span>          4m18s<br><br><span class="token comment">### stopping the load now</span><br>php-apache   Deployment/php-apache   <span class="token number">73</span>%/50%    <span class="token number">1</span>         <span class="token number">10</span>        <span class="token number">5</span>          4m48s<br>php-apache   Deployment/php-apache   <span class="token number">0</span>%/50%     <span class="token number">1</span>         <span class="token number">10</span>        <span class="token number">5</span>          5m49s<br>php-apache   Deployment/php-apache   <span class="token number">0</span>%/50%     <span class="token number">1</span>         <span class="token number">10</span>        <span class="token number">5</span>          10m<br>php-apache   Deployment/php-apache   <span class="token number">0</span>%/50%     <span class="token number">1</span>         <span class="token number">10</span>        <span class="token number">1</span>          10m</code></pre>
<h2>Autoscaling on mutliple and custom metrics</h2>
<p>Please follow <a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/#autoscaling-on-multiple-metrics-and-custom-metrics">this document</a> for more advanced usage of HPA</p>
<h2>Delete test application</h2>
<p>kubectl delete deployment.apps/php-apache service/php-apache horizontalpodautoscaler.autoscaling/php-apache</p>

        </div>
        <div class="col-lg-3 col-md-2 mx-auto">
          <div>Categories</div>
          <ul>
          
            <li>hpa</li>
          
            <li>autoscaling</li>
          
            <li>metrics</li>
          
          </ul>
        </div>
      </div>
    </div>
  </section>
  <footer><div class="container"><div class="row"><div class="col-12">
    &copy; 2020-2021. All right reserved. Vijay Dharap.
  </div></div></div></footer>
</body>

</html>
